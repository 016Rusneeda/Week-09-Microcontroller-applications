digraph ESP32_GPIO2_LED_System {
    // Graph settings
    rankdir=TB;  // Top to Bottom (vertical flow)
    bgcolor="white";
    node [fontname="Arial", fontsize=11];
    edge [fontname="Arial", fontsize=10];
    
    // CPU Layer
    subgraph cluster_cpu {
        label="ESP32 Core";
        style=filled;
        fillcolor="#E6F3FF";
        fontsize=12;
        fontname="Arial Bold";
        
        app [label="User Code\ngpio_set_level()", shape=box, style=filled, fillcolor="#87CEEB"];
        esp_idf [label="ESP-IDF\nGPIO Driver", shape=box, style=filled, fillcolor="#98FB98"];
    }
    
    // System Bus
    bus_matrix [label="Bus Matrix\n(AHB/APB)", shape=box, style=filled, fillcolor="#DDA0DD"];
    
    // GPIO System
    subgraph cluster_gpio {
        label="GPIO System";
        style=filled;
        fillcolor="#F0FFF0";
        fontsize=12;
        fontname="Arial Bold";
        
        gpio_reg [label="GPIO Registers\nOUT_REG[2]", shape=box, style=filled, fillcolor="#F0E68C"];
        gpio_matrix [label="GPIO Matrix\nSignal Router", shape=box, style=filled, fillcolor="#FFB6C1"];
        io_mux [label="IO MUX\nPin Driver", shape=box, style=filled, fillcolor="#FFA07A"];
    }
    
    // Physical Pin
    gpio2_pin [label="GPIO 2\nPhysical Pin", shape=ellipse, style=filled, fillcolor="#90EE90"];
    
    // External Circuit
    subgraph cluster_external {
        label="External Circuit";
        style=filled;
        fillcolor="#FFFACD";
        fontsize=12;
        fontname="Arial Bold";
        
        resistor [label="470Ω\nResistor", shape=box, style=filled, fillcolor="#FFE4B5"];
        led [label="Red LED\n1.7V", shape=ellipse, style=filled, fillcolor="#FF6B6B"];
        gnd [label="GND", shape=box, style=filled, fillcolor="#D3D3D3"];
    }
    
    // Vertical Data Flow (Top to Bottom)
    app -> esp_idf [label="API Call", color="blue", penwidth=2];
    esp_idf -> bus_matrix [label="Register Write", color="blue", penwidth=2];
    bus_matrix -> gpio_reg [label="Set Bit 2", color="blue", penwidth=2];
    gpio_reg -> gpio_matrix [label="Digital Signal", color="red", penwidth=2];
    gpio_matrix -> io_mux [label="Route to Pin", color="red", penwidth=2];
    io_mux -> gpio2_pin [label="3.3V/0V", color="red", penwidth=3];
    
    // External Circuit Flow (continues downward)
    gpio2_pin -> resistor [label="Current\nLimit", color="red", penwidth=2];
    resistor -> led [label="3.4mA", color="red", penwidth=2];
    led -> gnd [label="Return Path", color="blue", penwidth=2];
    
    // Title
    label="ESP32 GPIO2 → LED Control Flow";
    labelloc="t";
    fontsize=16;
    fontname="Arial Bold";
}
